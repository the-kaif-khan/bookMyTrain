<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>map page with products</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    #map{
      height: 90vh;
      width: 100%;
    }
  </style>

      <!-- google translate hidden element (head) -->
<div id="google_translate_element" style="display:none;"></div>

<script>
  function googleTranslateElementInit() {
    new google.translate.TranslateElement({
      pageLanguage: 'en',
      includedLanguages: 'en,hi,bn,ur,ta,te,pa,gu,ml,mr,it',
      autoDisplay: false,
    }, 'google_translate_element');
  }
</script>
<script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

</head>
<body>

  <h1>Explore products on map</h1>
  <div id="map"></div>


  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    
    // initialize the map
    var map = L.map('map').setView([20,0],2);

    // tilelayer (osm layer) for map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  const products = <%- JSON.stringify(mapProducts) %>;

  products.forEach((product) => { 
  var marker = L.marker([ product.latitude,  product.longitude ]).addTo(map);
  var popupContent = `
    <img src="data:image/jpeg;base64, ${product.productImages[0].toString('base64')}" width= '100' height= '100'><br>
    <a href= '/buy/viewproduct/${product.productId}/${product.city}/${product.tehsil}'>Click here to view product</a>
   `;
  marker.bindPopup(popupContent);
  });

  </script>


  <select id="languageSelect language-select" hidden>
    <option value="en">English</option>
    <option value="hi">हिन्दी</option>
    <option value="bn">বাংলা</option>
    <option value="ur">اردو</option>
    <option value="ta">தமிழ்</option>
    <option value="te">తెలుగు</option>
    <option value="pa">ਪੰਜਾਬੀ</option>
    <option value="gu">ગુજરાતી</option>
    <option value="ml">മലയാളം</option>
    <option value="mr">मराठी</option>
    <option value="it">Italiano</option>
  </select>


  <script>
  (function() {
const SELECT_ID = 'languageSelect';
const STORAGE_KEY = 'preferredLanguage';
const defaultSourceLang = 'en';

function setCookie(name, value, days, path = '/') {
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = `${name}=${value};expires=${d.toUTCString()};path=${path}`;
}

function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? decodeURIComponent(match[2]) : null;
}

// Extract target language from googtrans cookie ("/en/hi" → "hi")
function currentLangFromCookie() {
  const c = getCookie('googtrans');
  if (!c) return defaultSourceLang;
  const parts = c.split('/');
  return parts[2] || defaultSourceLang;
}

function trySetComboLang(lang) {
  const combo = document.querySelector('.goog-te-combo');
  if (combo) {
    if (combo.value !== lang) {
      combo.value = lang;
      combo.dispatchEvent(new Event('change'));
      console.log('Translate combo switched →', lang);
    } else {
      console.log('Language already active →', lang);
    }
    return true;
  }
  return false;
}

function fallbackSetLang(lang) {
  try {
    setCookie('googtrans', `/${defaultSourceLang}/${lang}`, 365, '/');
    setCookie('googtrans', `/${defaultSourceLang}/${lang}`, 365, '/');
    window.location.reload();
  } catch (e) {
    console.error('fallbackSetLang error', e);
  }
}

function setLanguage(lang) {
  localStorage.setItem(STORAGE_KEY, lang);

  // prevent loop if already same language
  const current = currentLangFromCookie();
  if (current === lang) {
    console.log('Skip re-translate (already', lang, ')');
    return;
  }

  let attempts = 0;
  const maxAttempts = 25;
  const interval = setInterval(() => {
    attempts++;
    const done = trySetComboLang(lang);
    if (done) {
      clearInterval(interval);
      return;
    }
    if (attempts >= maxAttempts) {
      clearInterval(interval);
      console.warn('Combo not found, fallback to cookie');
      fallbackSetLang(lang);
    }
  }, 100);
}

function initSelector() {
  const sel = document.getElementById(SELECT_ID);
  if (!sel) return;

  // restore saved
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    sel.value = saved;
    const current = currentLangFromCookie();
    if (current !== saved) {
      setLanguage(saved);
    }
  }

  sel.addEventListener('change', function() {
    const lang = this.value;
    setLanguage(lang);
  });
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSelector);
} else {
  initSelector();
}
})()

  </script>
  
</body>
</html>