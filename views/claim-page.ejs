<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>claim page</title>

  <link rel="stylesheet" href="/stylesheets/claimCartPagesCSS/claimCartBody.css">
  <link rel="stylesheet" href="/stylesheets/claimCartPagesCSS/claimCartHeader.css">
  <link rel="stylesheet" href="/stylesheets/buyingCartPagesCSS/buying-now-cart-footer.css">
  <link rel="stylesheet" href="/stylesheets/claimCartPagesCSS/claimCartProducts.css">
  <link rel="stylesheet" href="/stylesheets/claimCartPagesCSS/claimCartSidebar.css">

</head>
<body>
  <!-- header -->
  <div class="cartHeading">
    <div class="cartHeadingLogo">
      <a href="/home/landbook">
        <img src="/imagesAndVideos/Logos/LOGO/Wow3.png" alt="">
      </a> 
    </div>
    <div class="cartHeadingText">
        Checkout 
      <span class="cartNumber js-cartNumber">
        (<%= claimProducts.length %>)
      </span> 
      <% if(claimProducts.length > 1) { %>
        Items
      <% } else if(claimProducts.length <= 1) { %>
        Item
      <% } %>
    </div>
  </div>

  <!-- navigations -->
  <div class="navigationsBox">
    <a href="/home/<%= theCity %>/<%= theTehsil %>" class="links">
      <div class="navLinks">
        Home
      </div>       
    </a>

    <a href="/home/sellpage/products/filter/<%= theCity %>/<%= theTehsil %>" class="links">
      <div class="navLinks">
        Products page
      </div>
    </a>

    <div class="navlinksOfCart">
      <a href="/buy/buyingcart/products/filter/<%= theCity %>/<%= theTehsil %>" class="buying">
        <div class="textBuyingCart">Buying Now Cart</div> <img src="/imagesAndVideos/Logos/Cart Icon.svg" alt="" class="buyingNowCartLink">
      </a>
      <div class="buyingNowCartNotification">
        <% if(currentUser) { %>
        <%= currentUser.buyingCart.length %>
        <% } else { %>
          0
        <% } %>
      </div>
    </div>

  </div>

  <!-- main body heading -->
  <p class="para">Review your order 
    <span class="buyingSummaryText">
      Buying summary is in last of the page.
    </span>
  </p>

  <% if(error.length > 0) { %>
    <div class="flash flash-error">
      <%= error %>
    </div>
  <% } %>
  <% if(success.length > 0) { %>
    <div class="flash flash-success">
      <%= success %>
    </div>
  <% } %>

  <div class="container">

    <!-- cart products in this div -->
    <div class="cartProductsContainer">
      <% if(claimProducts.length > 0) { %>
        <% claimProducts.forEach((product) => { %>
          <div id="<%= product._id %>">
            <div class="products">
              <div class="leftContainer">
                <div class="leftContainerHeading">
                  <b>If bought now:</b> Expected date when zameen 
                  will be bought: 24-02-2023
                </div>
                <div class="productImage">
                  <a href="/buy/viewproduct/<%= product._id %>/<%= theCity %>/<%= theTehsil %>">
                    <img src="data:image/jpeg;base64, <%= product.productImages[0].toString('base64') %>" alt="">
                  </a>
                </div>
                <div class="productPriceAndLB">
                  <div class= "productPrice">
                    Price: <%= product.landbookPrice %> Lakhs
                  </div>
                  <div class= "productLB">
                    L*B: <%= product.LB %>
                  </div>
                </div>
                <div class="productSpec">
                  <ol type="a">
                    <% product.spec.forEach((list) => { %>
                      <li><%= list %></li>
                    <% }); %>
                  </ol>
                </div>
                <div class="buyNow">
                  <a href="/buy/buyingForm/<%= product._id %>/<%= theCity %>/<%= theTehsil %>" class="buyNowLink">
                  <button class="buyNowButton js-buy-now">
                    Buy Now Within 48 Hours.
                  </button>
                  </a>
                </div>
              </div>
              <div class="rightContainer">
                <div class="rightContainerHeading">
                  After claiming by you:
                </div>
                <div class="newClaimed">
                  People claimed: <b> +<%= product.claimedPeople.length %></b>
                </div>
                <div class="newViews">
                  People viewed: <b> +<%= product.visits.length %></b>
                </div>

                <% if(buyingForm) { %>
                  <div class="timerTitle">
                    Time left for claimed people to give Bayana to this land
                  </div>
                  <div class="timer-container">
                    <div class="claimTimer" data-createdat="<%= buyingForm.createdAt %>" data-claimformid="<%= buyingForm._id %>">
                      Loading...
                    </div>
                    <div class="progress-bar">
                      <div class="claimProgress"></div>
                    </div>
                  </div>
                <% } %>

                <div class="redMessage <%= product.buyingForm.length > 0 ? 'blink-red-white'
                  : '' %>">
                  Buying by other notice
                </div>
                <a href="/buy/give-bayana/<%= theCity %>/<%= theTehsil %>/<%= product._id %>" class="links">
                  <div class="bayanaBox">
                    Click to give bayana to this zameen.
                  </div>
                </a>
                <a href="/buy/remove/claimcart/<%= product._id %>" class="removeProduct">
                  <div class= "removeProduct js-remove-product">
                    Remove product
                  </div>
                </a>
              </div> 
            </div> 
          </div>
        <% }) %>
      <%} else { %>
        <div class="noProducts">
          There is no products claimed by you in <span class="highlight"><%= theTehsil %></span> tehsil. You can try different tehsil in filter and if not found, then either you haven't claim a product or you can just check your profile's claim cart option... there you will get every tehsil's claimed products by you.
        </div>
      <% } %>

    </div>
    <!-- cart products in this upper div -->

    <!-- buying summary -->

    <% 
    let sellerPrice = 0;
    <!-- let landbookPrice = 0; -->
    claimProducts.forEach((claimProduct) => {
      sellerPrice += claimProduct.sellerPrice;
    });
    const likhwayiFemale = sellerPrice * 0.07;
    const likhwayiMale = sellerPrice * 0.08;
    const brokerCost = sellerPrice * 0.038;
    const landbookCost = sellerPrice * 0.023;
    const customerSaved = brokerCost - landbookCost;
    const finalMale = sellerPrice + likhwayiMale + landbookCost;
    const finalFemale = sellerPrice + likhwayiFemale + landbookCost;
    %>


    <!-- buying summary -->
    <% if(claimProducts.length > 0) { %>
      <div class="buyingSummary js-buying-summary">

        <form id="autoFilterForm" action="/buy/claimcart/products/filter/<%= theCity %>/<%= theTehsil %>" method="GET" class="vertical-filter">
        
          <div class="filterTitle">
            Sort by: 
          </div>
          <label>City</label>
          <select name="city" id="cityDropdown" onchange="updateTehsils();submitFilters()">
            <option value="">Select City</option>
            <% cityTehsilList.forEach(item => { %>
              <option value="<%= item.city %>" <%= selectedFilters.city === item.city ? 'selected' : '' %>><%= item.city %></option>
            <% }) %>
          </select>
          
          <label>Tehsil</label>
          <select name="tehsil" id="tehsilDropdown" onchange="submitFilters()">
            <option value="">Select Tehsil</option>
          </select>
          
          <script>
            const cityTehsilMap = {
              <% cityTehsilList.forEach(item => { %>
                "<%= item.city %>": <%- JSON.stringify(item.tehsils) %>,
              <% }) %>
            };
          
            function updateTehsils() {
              const city = document.getElementById('cityDropdown').value;
              const tehsilSelect = document.getElementById('tehsilDropdown');
              tehsilSelect.innerHTML = '<option value="">Select Tehsil</option>';
          
              if (cityTehsilMap[city]) {
                cityTehsilMap[city].forEach(teh => {
                  const opt = document.createElement('option');
                  opt.value = teh;
                  opt.textContent = teh;
                  tehsilSelect.appendChild(opt);
                });
              }
            }
          
            // Load selected tehsil on page load
            window.onload = function () {
              updateTehsils();
              const selectedTehsil = "<%= selectedFilters.tehsil || '' %>";
              if (selectedTehsil) {
                document.getElementById('tehsilDropdown').value = selectedTehsil;
              }
            };
          </script>
        </form>
        <a href="/buy/claimcart/products/filter/<%= theCity %>/<%= theTehsil %>" class="clear-filters">
          Clear All Filters
        </a>

        <div class="buyingSummaryHeading">
          Buying Summary
        </div>
        <div class="numberOfZameens">
          Zameens (<span class="js-cartItemNumber"><%= claimProducts.length %></span>)
        </div>
        <div class="buyingSummaryContentsContainer">
          <div class="buyingSummaryContents">
            <div class="landbookTitle">
              Landbook Price
            </div>
            <div class="titles">
              Seller Price:
            </div>
            <div class="numbers">
              <b><%= sellerPrice.toFixed(2) %> Lakhs.</b>
            </div>
            <div class="titles">
              Likhwayi [female(6%) / male(7%) + 1% regn.charges]
            </div>
            <div class="numbers">
              <b><%= likhwayiFemale.toFixed(2) %> Lakhs </b> (female)
            </div>
            <div class="titles">
              Likhwayi (Male)
            </div>
            <div class="numbers">
              <b><%= likhwayiMale.toFixed(2) %> Lakhs</b>
            </div>
            <div class="titles">
              <span class="logo">Landbook</span> <a href="" class="convenienceLinks">
                convenience
              </a> fee (0.8%)
            </div>
            <div class="landbookConvenience">
              <b><%= landbookCost.toFixed(2) %> Lakhs</b>
            </div>
          </div>


          <div class="buyingSummaryContents">
            <div class="brokerTitle">
              Broker Price
            </div>
            <div class="titles">
              Price:
            </div>
            <div class="numbers">
              <b><%= sellerPrice.toFixed(2) %> Lakhs.</b>
            </div>
            <div class="titles">
              Likhwayi [female(6%) / male(7%) + 1% regn.charges]
            </div>
            <div class="numbers">
              <b><%= likhwayiFemale.toFixed(2) %> Lakhs</b>(female)
            </div>
            <div class="titles">
              Likhwayi (Male)
            </div>
            <div class="numbers">
              <b><%= likhwayiMale.toFixed(2) %> Lakhs</b>
            </div>
            <div class="titles">
              Broker convenience fee (1.5 + 2.3)%
            </div>
            <div class="brokerConvenience">
              <b><%= brokerCost.toFixed(2) %> Lakhs</b> <a href="" class="sourceLinks">source</a>
            </div>
          </div>

          <div class="lastTitles">
            You saved: {(broker)-(landbook)} convenience fee: 
          </div>
          <div class="numbers">
            <b><%= customerSaved.toFixed(2) %> lakhs.</b>
          </div>
          <div class="landbookPriceTitle">
            Total Price (Female):
          </div>
          <div class="landbookPrice">
            <b><%= finalFemale.toFixed(2) %> lakhs.</b>
          </div>
          <div class="landbookPriceTitle">
            Total Price (Male):
          </div>
          <div class="landbookPrice">
            <b><%= finalMale.toFixed(2) %>lakhs.</b>
          </div>

        </div>
      </div>
    <% } %>

  </div>

  <!-- footer container -->
  <footer>

    <div class="aboutThisPage">
      <div class="pageLanguage">
        <div class="languageImage">
          <img src="/imagesAndVideos/Logos/LOGO/Wow3.webp" alt="">
        </div>
        <div class="languageText">
          English
        </div>  
      </div>

      <div class="aboutCountry">
        <div class="aboutCountryImage">
          <img src="/imagesAndVideos/Logos/LOGO/Wow4.webp" alt="">
        </div>
        <div class="aboutCountryText">
          India
        </div>
      </div>
    </div>

    <div class="aboutCompany">
      <div class="companyConditions aboutCompanyTexts">
        Conditions of Use
      </div>
      <div class="companyPrivacyPolicy aboutCompanyTexts">
        Privacy Notice
      </div>
      <div class="aboutAdvertising aboutCompanyTexts">
        Interest-Based Ads
      </div>
    </div>

    <div class="companyCopywrite">
      .c. 1996-2024, Landbook.com, Inc. and its affiliates
    </div>

  </footer>


  <script src="/javascripts/claimTimer.js"></script>
  <!-- <script>
   function submitFilters() {
    document.getElementById('autoFilterForm').submit();
  }
      const claimTimers = document.querySelectorAll('.claimTimer');
      claimTimers.forEach(timer => {
      const createdAt = new Date(timer.dataset.createdat);
      const endTime = new Date(createdAt.getTime() + 4 * 60 * 1000);
      const formId = timer.dataset.claimformid;
      const progressBar = timer.nextElementSibling.querySelector('.claimProgress');

      function updateTimer() {
        const now = new Date();
        const diff = endTime - now;
        const total = 4 * 60 * 1000;
        if(diff <= 0) {
          timer.textContent = 'Time Over';
          timer.classList.add('over');
          progressBar.style.width = '0%';
          // move automatically
          // fetch(`/home/admin/move-buying-form/${formId}`, {
          //   method: 'POST'
          // }).then(res => {
          //   if(res.ok) {
          //     console.log('Product moved to buying cart automatically!');
          //     location.reload();
          //   }
          // });
        } else {
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);
          timer.textContent = `${hours}hr ${minutes}min ${seconds}sec`;
          // update progress bar
          const percentage = (diff / total) * 100;
          progressBar.style.width = `${percentage}`;
        }
      }
      setInterval(updateTimer, 1000);
      updateTimer();
    })
    // for claimTimer scripts ends here
  </script> -->

</body>
</html>